<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

 
 <!-- 
		 Fontawesome -->
		 <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

		 <!-- Fine FontAwesome -->
		 
		 <!-- Dropzone
		  -->
		  <script src="lib/dropzone/dropzone.js"></script>
		  <!-- 
		  Fine dropzone -->
		  
		  <!-- 
		  Parser -->
		   <script src="js/parser/parser.js"></script>
		   <!-- Fine parser -->
		   
		   <script type="text/javascript">
		   
		   function color()
		   {
			   for(i=0;i<selectedItems.length;i++)
       			{
       				if((mapPaperElement[selectedItems[i]].name=='STATION') || (mapPaperElement[selectedItems[i]].name=='Name'))
       					j++;
				} 
		   }
		   
		   function print()
			{
				 var myWindow=window.open('','','width=200,height=100');
				 myWindow.document.write("<p>"+$('#myholder').html()+"</p>");
				    
				    myWindow.document.close();
				myWindow.focus();
				myWindow.print();
				myWindow.close();
			}
		   
		   function manageEntities()
		   {
			   $('#entities').empty();
			   
				$('#entities').append("<option value='Choose'>Choose</option>");

			   
			   for (var key in map_entity)
				{
				   $('#entities').append("<option value='"+map_entity[key].name+"'>"+map_entity[key].name+"</option>");
				}
		   }
		   
		   function addEntity()
		   {
			   
			   	if(check())
				   alert("Error!");
			   	else
				{
				  
				 	var entity = {};
					entity.object = null;

					entity.type='spatial';
					
					entity.name=$("#entityName").val();

					entity.x=121;
					entity.y=358;
					
					entity.attribute=new Array();

					//add first attribute
					var attribute = {};
					attribute.object = null;
					attribute.type = 'normal';
					attribute.key=true;
					attribute.entity=entity.name;
					attribute.x=201;
					attribute.y=297;
					attribute.name=$("#attributeName_1").val();
					entity.attribute.push(attribute);
					
					//add second attribute
					attribute = {};
					attribute.object = null;
					//attributo spaziale vedi come gestirlo
					attribute.type = 'normal';
					attribute.key=false;
					attribute.entity=entity.name;
					attribute.x=92;
					attribute.y=290;
					attribute.name=$("#attributeName_2").val();
					entity.attribute.push(attribute);
					map_entity[entity.name] = entity;
					
					var relation = {};
					relation.object = null;

					relation.type ="relation";
					relation.name='located';
						
					relation.entityNameFirst=$("#entities option:selected").text();
					relation.entityNameSecond=entity.name;
						
					relation.x=322;
					relation.y=348;

					map_relation[relation.name] = relation;
					
					//delete all entity, relation & attribute on schema
					clear();
					//draw a new schema
					draw();
				}
				
		   }
			   	
			function clear()
			{
				graph.get('cells').forEach(function(cell){
						var view = paper.findViewByModel(cell)
						view.remove();
						});
			}
		   
		   function check()
		   {
			   flag=false;
			   if($("#entities option:selected").text()=="Choose")
					flag=true;
			   
			   
			   if($("#entityName").val()=="")
					flag=true;
			   
			   if($("#attributeName_1").val()=="")
					flag=true;
			   
			   if($("#attributeName_2").val()=="")
					flag=true;
			   
			   return flag;
		   }
		   function load()
		   {
			   $('#operation').hide();
		   }
		   
		   function query()
		   {
			  	if(selectedItems.length<1)
	        	{
	        		$("#alert").append( "<div class='alert alert-warning alert-dismissible fade show' role='alert'>"+
	  					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
	  		    "<span aria-hidden='true'>&times;</span>"+
	  		    "</button><strong>Warning!</strong> You must select an item.</div>" );
	        	}
			  	
			  	var s="";
			  	for(i=0;i<selectedItems.length;i++)
        		{
        			s=s+mapPaperElement[selectedItems[i]].name+";";
				}
			  	alert(s);
			  	
			  	if(selectedItems.length==1)
			  	{
			  		if(mapPaperElement[selectedItems[0]].name=='ID')
		        	{
		        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=prova","_blank");
		        	}
			  		else if(mapPaperElement[selectedItems[0]].name=='STATION')
		        	{
		        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=All Stations","_blank");
		        	}
				  	else if(mapPaperElement[selectedItems[0]].name=='Neighborhoods')
		        	{
		        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=All Neighborhoods","_blank");
		        	}
				  	else if(mapPaperElement[selectedItems[0]].name=='Restaurants')
		        	{
		        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=All Restaurants","_blank");
		        	}
				  	else
		        	{
		        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
			    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
			    		    "<span aria-hidden='true'>&times;</span>"+
			    		    "</button><strong>Warning!</strong> Query not available</div>" );
		        	}
			  	}
			  	else if(selectedItems.length==2)
			  	{
			  		if(mapPaperElement[selectedItems[0]].name=='STATION' && mapPaperElement[selectedItems[1]].name=='Name')
		        	{
				  		var station_name = window.prompt("Please enter Station name", "Harborside");
		        		window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Where is the station?&param="+station_name,"_blank");
		        	}
			  		else if(mapPaperElement[selectedItems[0]].name=='Restaurants' && mapPaperElement[selectedItems[1]].name=='Name')
		        	{
		        		var restaurant_name = window.prompt("Please enter Restaurant name", "Riviera Caterer");
		        		window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=What are the restaurant within a radius of 500.0m to 1000.0m from Riviera Caterer restaurant ?","_blank");
		        	}
			  		else if(mapPaperElement[selectedItems[0]].name=='TRIP' && mapPaperElement[selectedItems[1]].name=='Duration') 
			        {
		        		var station_name1 = window.prompt("Please enter Station name #1", "Exchange Place");
	        			var station_name2 = window.prompt("Please enter Station name #2", "Harborside");
		        		window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Trip with longer duration between the Exchange Place departure station and the Harborside end station","_blank");
		        		
			        }
			  		else
		        	{
		        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
			    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
			    		    "<span aria-hidden='true'>&times;</span>"+
			    		    "</button><strong>Warning!</strong> Query not available</div>" );
		        	}
			  	}
			  	else if(selectedItems.length==4)
			  	{
			  		if(mapPaperElement[selectedItems[0]].name=='Neighborhoods' && mapPaperElement[selectedItems[1]].name=='placed' && mapPaperElement[selectedItems[2]].name=='Restaurants' && mapPaperElement[selectedItems[3]].name=='Name' )
		        	{
		        			var restaurant_name = window.prompt("Please enter Restaurant name", "Riviera Caterer");
		        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=In which neighborhood is the Riviera Caterer restaurant ?","_blank");
		        			//var neighborhoods_name = window.prompt("Please enter Neighborhood name", "Riviera Caterer");
		        			//	window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Restaurants in the "+neighborhoods_name+" Neighborhood","_blank");
		        			
		        	}
		        	else if(mapPaperElement[selectedItems[0]].name=='STATION' && mapPaperElement[selectedItems[1]].name=='Name' && mapPaperElement[selectedItems[2]].name=='Lat' && mapPaperElement[selectedItems[3]].name=='Long' )
			        {
		        		var station_name1 = window.prompt("Please enter Station name #1", "Exchange Place");
	        			var station_name2 = window.prompt("Please enter Station name #2", "Essex Light Rail");
	        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Distance as crow flies between Exchange Place stations and Essex Light Rail station on map!","_blank");
	        		
			        }
		        	else
		        	{
		        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
			    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
			    		    "<span aria-hidden='true'>&times;</span>"+
			    		    "</button><strong>Warning!</strong> Query not available</div>" );
		        	}
			  	}
			  	else
	        	{
	        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
		    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
		    		    "<span aria-hidden='true'>&times;</span>"+
		    		    "</button><strong>Warning!</strong> Query not available</div>" );
	        	}
	        		
	        	/*
	        	else if(selectedItems.length==2)
	        	{
	        		var i=0;
	        		var j=0;
	        		for(i=0;i<selectedItems.length;i++)
	        		{
	        			if((mapPaperElement[selectedItems[i]].name=='STATION') || (mapPaperElement[selectedItems[i]].name=='Name'))
	        				j++;
					}
	        		
	        		if(j==2)
	        		{
	        			//cambia il nome metti disegno della linea
	        			var station_name1 = window.prompt("Please enter Station name #1", "Exchange Place");
	        			var station_name2 = window.prompt("Please enter Station name #2", "Essex Light Rail");
	        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Distance as crow flies between "+station_name1+" stations and "+station_name2+" station on map!");
	        		}
	        		else
	        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
		    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
		    		    "<span aria-hidden='true'>&times;</span>"+
		    		    "</button><strong>Warning!</strong> Select the STATION entity & Name attribute to execute the query</div>" );
	        	}
	        	else if(selectedItems.length==4)
	        	{
	        		var i=0;
	        		var j=0;
	        		for(i=0;i<selectedItems.length;i++)
	        		{
	        			if((mapPaperElement[selectedItems[i]].name=='Lat') || (mapPaperElement[selectedItems[i]].name=='Duration') || (mapPaperElement[selectedItems[i]].name=='Name') || (mapPaperElement[selectedItems[i]].name=='Long'))
	        				j++;
					}
	        		
	        		if(j==4)
	        		{
	        			window.location.replace("http://localhost:8080/GeoCalk/map.html?cod=Trip with longer duration between the Exchange Place departure station and the Harborside end station");
	        		}
	        		else
	        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
		    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
		    		    "<span aria-hidden='true'>&times;</span>"+
		    		    "</button><strong>Warning!</strong> Select Lat, Long, Name and Duration attribute to execute the query</div>" );
	        	
	        	}
			  	*/
				 
			}
		  
		   
		   
		   </script>
		  
</head>
<body onLoad="load();">

<div class="container">


<!-- Modal legend-->
<!-- 
<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Entity Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="information">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
  </div>
</div>
</div>
-->
<!-- end modal legend -->

<!-- Modal Add entity -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Manage Entities</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="examplePaper" style="text-align:center;">
      <img src="img/exampleModel.png" width="470px" height="370px;"/>
      </div>
      <div class="modal-body">
      <table style="text-align:center;margin-left:auto;margin-right:auto;">
      <tr>
	      <td>
	      	<p>Binds to Entity&nbsp;&nbsp;&nbsp;&nbsp;</p>
	      </td>
	      <td>
		      <select id="entities" style="border-radius: 5px 5px 5px 5px;width:200px;">
		        
		      </select>
	     </td>
	  </tr>
	  <tr>
	      <td>
	      	<p>Entity name&nbsp;&nbsp;&nbsp;&nbsp;</p>
	      </td>
	      <td>
	      	<input type="text" placeholder="Neighborhoods" id="entityName" style="border-radius: 5px 5px 5px 5px;"/>
	     </td>
	  </tr>
	  <tr>
	      <td>
	      	<p>Attribute name&nbsp;&nbsp;&nbsp;&nbsp;</p>
	      </td>
	      <td>
	      	<input type="text" placeholder="Name" id="attributeName_1" style="border-radius: 5px 5px 5px 5px;"/>
	     </td>
	  </tr>
	  <tr>
	      <td>
	      	<p>Attribute name&nbsp;&nbsp;&nbsp;&nbsp;</p>
	      </td>
	      <td>
	      	<input type="text" placeholder="Geometry (Polygon)" id="attributeName_2" style="border-radius: 5px 5px 5px 5px;"/>
	     </td>
	  </tr>
     </table>
       
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="addEntity();">Add Entity</button>
      </div>
    </div>
  </div>
</div>
<!-- end modal add entity -->

<!-- Modal Query-->
<div class="modal fade" id="queryModalCenter" tabindex="-1" role="dialog" aria-labelledby="queryModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Run Queries</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      
      <div style="text-align:center;" id="query1">
      <i class="fas fa-map-marked fa-7x" style="color:#0099ff" ></i><br/>
      <a href="#" onclick="query(this);">Where is the Exchange Place station?</a>
      </div>
      
      <div style="text-align:center;" id="query2">
      <i class="fas fa-map-marked fa-7x" style="color:#0099ff" ></i><br/>
      <a href="#" onclick="query(this);">Where is the Exchange Place station?</a>
      </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- end modal query -->


  <div class="row" style="margin-top:20px;" >
    <div class="col col-lg-4" style="padding-left:5s0px;">
    <a href="index.html"><img src="img/logo.png" /></a>
    </div>
    <div class="col col-lg-4" style="text-align:center;" id="operation">
     <div style="padding-top:10px;">
    		<!-- <a href="#"  data-toggle="modal" data-toggle="modal" data-target="#exampleModalLong" onclick="info();return false;"><span style="padding-left:20px;color:#00bfff;"><i class="far fa-question-circle fa-2x"></i></span></a>-->
    		<a href="#"  data-toggle="modal" onclick="info();return false;"><span style="padding-left:20px;color:#00bfff;"><i class="far fa-question-circle fa-2x"></i></span></a>
     		<a href="#"  data-toggle="modal" data-target="#exampleModalCenter" onclick="manageEntities();return false;"><span style="padding-left:20px;color:green;"><i class="fas fa-plus fa-2x"></i></span></a>
     		
     		
     		<a href="#" onclick="print();return false;"><span style="padding-left:20px;color:#0040ff;" ><i class="fas fa-download fa-2x"></i></span></a>
     		<a href="#" onclick="query();return false;" id="qry"><span style="padding-left:20px;color:black;"><i class="fas fa-terminal fa-2x"></i></span></a>
     		<a href="#" onclick="save();return false;"><span style="padding-left:20px;color:#0040ff;" ><i class="fas fa-print fa-2x"></i></span></a>
     		
     </div>
    </div>
    <div class="col col-lg-2" style="padding-top:10px;text-align:center;">
    
    </div>	
  </div>
  
  <div class="row">
    <div class="col col-lg-12" style="text-align:center;margin-top:20px;" id="alert">
   
   </div>
   	
  </div>
  
 <div class="row justify-content-md-center" style="padding-top:50px;" id="droparea">
    <div class="col col-lg-12" style="text-align:center;" id="paper">
   <form action="#" class="dropzone needsclick dz-clickable" style="border:none;" id="myDropzone" method="post" enctype="multipart/form-data">
						<div class="dz-message needsclick" style="border:none;">
							<img src="img/dropzone.gif" width="40%" height="40%">
              
						</div>
						<div id="schema1" style="padding:20px 20px 20px 20px;" >
              </div>
              			</form>
  </div>
  </div>
 
  <div class="row" style="padding-top:20px;">

   <!-- <div class="col-lg-12" id="myholder" style="visibility:hidden;"> -->
     <div class="col-lg-12" id="myholder">
  </div>
</div>
<div class="row justify-content-md-center" style="margin-top:10px;">
    <div class="col col-lg-2">
      <!-- Nulla -->
    </div>
    <div class="col-md-auto" style="text-align:center;">
    Copyright &copy; 2019 GeoCalk. All Rights Reserved. Designed by <a href="http://www.depiano.it">Antonio De Piano</a>.
    <br/>
    Master’s Degree in Computer Science at the University of Salerno.
    </div>
    <div class="col col-lg-2">
      <!-- Nulla -->
    </div>
  </div>
</div>


    <!-- content -->
   <!--  <div id="myholder"></div> -->
    
    <!-- dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.js"></script>

    <!-- code -->
    <script type="text/javascript">
 
    	var graph;
    	var paper;
    	
        Dropzone.options.myDropzone = {
        		init: function() {
        			this.on("addedfile", function(file)
        			{ 
        				var filename= file.name.split('.');
        				//Controllo se .xmi
        				if (filename[1] != "xmi")
        				{
        					this.removeAllFiles();
        					
        					var div = document.createElement('div');
        						div.id="msg_schema1";
        						div.className = "alert alert-danger"; 
        						var t="<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a><strong>Attenzione! </strong> Formato non corretto.<br/>";
        						div.innerHTML=t;
        						
        					if(document.getElementById('msg_schema1')==undefined)
        					{
        					   document.getElementById('schema1').appendChild(div);
        					}
        					else
        					{
        						document.getElementById('schema1').replaceChild(div,document.getElementById('msg_schema1'));
        					}
        				}
        				else if(filename[1]=="xmi")
        				{
        					checkParser(file,file.name,this);
        					
        				}
        			});
        		}
        	};
        
        function checkParser(file,filenam,ob)
    	{
        					var filename = filenam.replace(/C:\\fakepath\\/i, '');
    						path="temp/"+filename;
    						file1 = filename;
    						schema=1;
    						$.ajax({
    						type: "GET",
    						url: path,
    						dataType: "xml",
    						success: parseIt,error: function()
    						{
    							//Se si verifica un errore nel parser
    							var div = document.createElement('div');
    							div.id="msg_schema1";
    							div.className = "alert alert-danger"; 
    							var t="<a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>Parser error!";
    							div.innerHTML=t;
    							
    							if(document.getElementById('msg_schema1')==undefined)
    							{
    							   document.getElementById('schema1').appendChild(div);
    							}
    							else
    							{
    								document.getElementById('schema1').replaceChild(div,document.getElementById('msg_schema1'));
    							}			
    										
    							ob.removeAllFiles();
    						}
    						
    					
    		  });
    	}

        
        var map_entity = {};
        var map_relation = {};
        
        var mapPaperElement={};
        
        //Uso questo array per tenere traccia degli elementi selezionati
        var selectedItems=new Array();
        
        function arrayRemove(arr, value) {

        	   return arr.filter(function(ele){
        	       return ele != value;
        	   });

        	}
        
        function info()
        {
        	if(selectedItems.length<1)
        	{
        		$("#alert").append( "<div class='alert alert-warning alert-dismissible fade show' role='alert'>"+
  					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
  		    "<span aria-hidden='true'>&times;</span>"+
  		    "</button><strong>Warning!</strong> You must select an item.</div>" );
        	}
        	else if(selectedItems.length>1)
        	{
        		$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
    					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
    		    "<span aria-hidden='true'>&times;</span>"+
    		    "</button><strong>Warning!</strong> You must select an item.</div>" );
        	}
        	else if(selectedItems.length==1)
        	{
        		var str="";
        		if(mapPaperElement[selectedItems[0]].type=='normal' && (!mapPaperElement[selectedItems[0]].key))
        			str="Simple attribute";
        		else if(mapPaperElement[selectedItems[0]].type=='normal' && mapPaperElement[selectedItems[0]].key)
        			str="Simple attribute & Primary key";
        		else if(mapPaperElement[selectedItems[0]].type=='simple')
        			str=str="Simple entity";
        		else if(mapPaperElement[selectedItems[0]].type=='spatial')
        			str=str="Spatial entity";
        		else if(mapPaperElement[selectedItems[0]].type=='weakEntity')
        			str=str="Weak entity";
        		else if(mapPaperElement[selectedItems[0]].type=='relation')
        			str=str="Simple Relation";
        		else
        		{
        			$("#alert").append( "<div class='alert alert-danger alert-dismissible fade show' role='alert'>"+
      					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
      		    "<span aria-hidden='true'>&times;</span>"+
      		    "</button><strong>Error!</strong> Please try again later.</div>" );
        		}
        		
        		
        		$("#alert").append( "<div class='alert alert-info alert-dismissible fade show' role='alert'>"+
  					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
  		    "<span aria-hidden='true'>&times;</span>"+
  		    "</button><strong>Name: "+mapPaperElement[selectedItems[0]].name+"</strong>; Type: "+str+"</div>");
        	}
        		
        }
        
        function check(id)
        {
        	var i=0;
        	var flag=false;
        	for(i=0;i<selectedItems.length;i++)
        	{
        		if(selectedItems[i]==id)
        			flag=true;
        	}
        	return flag;
        }
        
        function parseIt(xml)
    	{
        	/*
        	alert("stampo l'array iniziale : "+selectedItems.toString());
        	selectedItems=arrayRemove(selectedItems, 5);
        	alert("stampo il nuovo array: "+selectedItems.toString());
        	*/
        	
        	$(xml).find('packagedElement').each(function()
    					{
    							//Controllo che sia un'entità
    							if($(this).attr('xmi:type')=="uml:Class")
    							{
    								//Oggetto dove memorizzo tutti i dati per poi creare l'elemento
    									var entity = {};
    									entity.object = null;

    									entity.type=$(this).attr('type');
    									
    									entity.name=$(this).attr('name');

    									if($(this).attr('x')!=undefined && $(this).attr('y')!=undefined)
    									{
	    									entity.x=parseInt($(this).attr('x'));
	    									entity.y=parseInt($(this).attr('y'));
    									}
    									
    									entity.attribute=new Array();

    									$(this).children("ownedAttribute").each(function()
    									{
    										if($(this).attr('xmi:type')=="uml:Property" && ($(this).attr('association')==undefined))
    										{
    											
    											var attribute = {};
    											attribute.object = null;
    											attribute.type = $(this).attr('type');
    											attribute.entity=entity.name;

    											if($(this).attr('x')!=undefined && $(this).attr('y')!=undefined )
    											{
    												attribute.x=parseInt($(this).attr('x'));
    												attribute.y=parseInt($(this).attr('y'));
    											}

    											attribute.name=$(this).attr('name');
    											
    											if($(this).find("details").attr("key")=="PK")
    													attribute.key=true;
    											else
    													attribute.key=false;
    											
    											entity.attribute.push(attribute);

    										}
    									});
    									
    									map_entity[entity.name] = entity;
    							}
    					});

    					$(xml).find('packagedElement').each(function()
    					{
    							if($(this).attr('xmi:type')=="uml:Association")
    							{

    								//controlla se una relazione è già stata considerata
    								var res=$(this).attr('xmi:id').split("__");
    								
    									//Crea oggetto relazione
    									var relation = {};
    									relation.object = null;

    									if($(this).attr('type')==undefined)
    										relation.type ="relation";
    									else
    										relation.type="ISA";

    									relation.name=$(this).attr('name');
    									
    									//res[0] contiene il nome della prima entità della relazione
    									//res[1] contiene il nome della seconda entità della relazione
    									relation.entityNameFirst=res[0];
    									relation.entityNameSecond=res[1];
    								
    									if($(this).attr('x')!=undefined && $(this).attr('y')!=undefined)
    									{
    										relation.x=parseInt($(this).attr('x'));
    										relation.y=parseInt($(this).attr('y'));

    									}

    									map_relation[relation.name] = relation;
    							}
    					});
    					
    					draw();
    		}

        function draw()
    	{
    		//Rimuovo la dropzone
    		$('#droparea').remove();
    		
    		 var erd = joint.shapes.erd;

    	        graph = new joint.dia.Graph();

    	        paper = new joint.dia.Paper({
    	            el: document.getElementById('myholder'),
    	            width: 1050,
    	            height: 600,
    	            model: graph,
    	            linkPinning: false,
    	            defaultConnectionPoint: function(line, view) {
    	                var element = view.model;
    	                return element.getConnectionPoint(line.start) || element.getBBox().center();
    	            }
    	        });
    	        

    	        // Custom highlighter - display an outline around each element that fits its shape.

    	        var highlighter = V('path', {
    	            'stroke': '#e9fc03',
    	            'stroke-width': '2px',
    	            'fill': 'transparent',
    	            'pointer-events': 'none'
    	        });

    	        // Define a specific highligthing path for every shape.

    	        erd.Attribute.prototype.getHighlighterPath = function(w, h) {

    	            return ['M', 0, h / 2, 'A', w / 2, h / 2, '0 1,0', w, h / 2, 'A', w / 2, h / 2, '0 1,0', 0, h / 2].join(' ');
    	        };

    	        erd.Entity.prototype.getHighlighterPath = function(w, h) {

    	            return ['M', w, 0, w, h, 0, h, 0, 0, 'z'].join(' ');
    	        };

    	        erd.Relationship.prototype.getHighlighterPath = function(w, h) {

    	            return ['M', w / 2, 0, w, w / 2, w / 2, w, 0, w / 2, 'z'].join(' ');
    	        };

    	        erd.ISA.prototype.getHighlighterPath = function(w, h) {

    	            return ['M', -8, 1, w + 8, 1, w / 2, h + 2, 'z'].join(' ');
    	        };

    	        // Define a specific connection points for every shape

    	        erd.Attribute.prototype.getConnectionPoint = function(referencePoint) {
    	            // Intersection with an ellipse
    	            return g.Ellipse.fromRect(this.getBBox()).intersectionWithLineFromCenterToPoint(referencePoint);
    	        };

    	        erd.Entity.prototype.getConnectionPoint = function(referencePoint) {
    	            // Intersection with a rectangle
    	            return this.getBBox().intersectionWithLineFromCenterToPoint(referencePoint);
    	        };

    	        erd.Relationship.prototype.getConnectionPoint = function(referencePoint) {
    	            // Intersection with a rhomb
    	            var bbox = this.getBBox();
    	            var line = new g.Line(bbox.center(), referencePoint);
    	            return (
    	                line.intersection(new g.Line(bbox.topMiddle(), bbox.leftMiddle())) ||
    	                line.intersection(new g.Line(bbox.leftMiddle(), bbox.bottomMiddle())) ||
    	                line.intersection(new g.Line(bbox.bottomMiddle(), bbox.rightMiddle())) ||
    	                line.intersection(new g.Line(bbox.rightMiddle(), bbox.topMiddle()))
    	            );
    	        };

    	        erd.ISA.prototype.getConnectionPoint = function(referencePoint) {
    	            // Intersection with a triangle
    	            var bbox = this.getBBox();
    	            var line = new g.Line(bbox.center(), referencePoint);
    	            return (
    	                line.intersection(new g.Line(bbox.origin(), bbox.topRight())) ||
    	                line.intersection(new g.Line(bbox.origin(), bbox.bottomMiddle())) ||
    	                line.intersection(new g.Line(bbox.topRight(), bbox.bottomMiddle()))
    	            );
    	        };


    	        // Unbind orignal highligting handlers.
    	        paper.off('cell:highlight cell:unhighlight');

    	        // Bind custom ones.
    	        paper.on('cell:highlight', function(cellView) {

    	            var padding = 5;
    	            var bbox = cellView.getBBox({ useModelGeometry: true }).inflate(padding);

    	            highlighter.translate(bbox.x, bbox.y, { absolute: true });
    	            highlighter.attr('d', cellView.model.getHighlighterPath(bbox.width, bbox.height));

    	            V(paper.viewport).append(highlighter);
    	        });
    	        
    	        
    	      //Per la selezione degli elementi
    	        paper.on('cell:pointerclick', 
    		    	    function(cellView, evt, x, y)
    		    	    { 
    		    	        if(check(cellView.model.id))
    		    	        {
    		    	        	if(mapPaperElement[cellView.model.id].type=="simple")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			  '.outer': {
      			    	                    fill: '#31d0c6',
      			    	                    stroke: 'none',
      			    	                  	strokeDasharray: '10,2',
      			    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
      			    	                },
      			    	                '.inner': {
      			    	                    fill: '#31d0c6',
      			    	                    stroke: 'none',
      			    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
      			    	                }
    		    	        		});
    		    	        		
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="weakEntity")
    		    	        	{
    		    	        	
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    	    	     	                '.inner': {
    	    	     	                    fill: '#FF33A5',
    	    	     	                    stroke: 'none',
    	    	     	                    points: '155,5 155,55 5,55 5,5',
    	    	     	                   filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	    	     	                },
    	    	     	                '.outer': {
    	    	     	                    fill: 'none',
    	    	     	                    stroke: '#FF33A5',
    	    	     	                    points: '160,0 160,60 0,60 0,0',
    	    	     	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	    	     	                }
    	    	     	            });
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="spatial")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
				    	                    fill: '#a030d0',
				    	                    stroke: 'none',
				    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
				    	                },
				    	                '.inner': {
				    	                    fill: '#a030d0',
				    	                    stroke: 'none',
				    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
				    	                } 
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="normal" && (!mapPaperElement[cellView.model.id].key))
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
          	        	                    fill: '#fe8550',
          	        	                    stroke: '#fe854f',
          	        	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
          	        	                }
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="normal" && mapPaperElement[cellView.model.id].key)
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
     	            	                '.outer': {
     	            	                    fill: '#feb662',
     	            	                    stroke: 'none',
     	            	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
     	            	                },
     	            	                '.inner': {
     	            	                    fill: '#feb662',
     	            	                    stroke: 'none'
     	            	                }
     	            	            });
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="multiValued")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.inner': {
     	        	    	                    fill: '#fe8550',
     	        	    	                    stroke: 'none',
     	        	    	                    rx: 43,
     	        	    	                    ry: 21

     	        	    	                },
     	        	    	                '.outer': {
     	        	    	                    fill: '#464a65',
     	        	    	                    stroke: '#fe8550',
     	        	    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
     	        	    	                }
     	        	    	            });
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="derived")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.inner': {
    	            	                    fill: '#fca079',
    	            	                    stroke: 'none',
    	            	                    display: 'block'
    	            	                },
    	            	                '.outer': {
    	            	                    fill: '#464a65',
    	            	                    stroke: '#fe854f',
    	            	                    'stroke-dasharray': '3,1',
    	            	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	            	                }
    	            	            });
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=='relation')
    		    	        	{
									mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
				    	                    fill: '#797d9a',
				    	                    stroke: 'none',
				    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
				    	                }
    		    	        		});
    		    	        	}		    	        	
    		    	        	
    		    	        	selectedItems=arrayRemove(selectedItems,cellView.model.id);
    		    	        	
    		    	        }
    		    	        else
    		    	        {
    		    	        	//alert("ci sono");
    		    	        	if(mapPaperElement[cellView.model.id].type=="simple" || mapPaperElement[cellView.model.id].type=="weakEntity")
    		    	        	{
    		    	        		//alert("entro");
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
    		    	        				fill: '#26C3FF'
    		    	        			},
    		    	        			'.inner':{
    		    	        				fill: '#26C3FF'
    		    	        			}
    		    	        		});
    		    	        		
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="spatial")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
    		    	        				fill: '#26C3FF'
    		    	        			},
    		    	        			'.inner':{
    		    	        				fill: '#26C3FF'
    		    	        			}
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="normal")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
    		    	        				fill: '#26C3FF'
    		    	        			},
    		    	        			'.inner':{
    		    	        				fill: '#26C3FF'
    		    	        			}
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="multiValued")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
    		    	        				fill: '#26C3FF',
    		    	        				stroke: '26C3FF'
    		    	        			},
    		    	        			'.inner':{
    		    	        				fill: '#26C3FF'
    		    	        			}
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=="derived")
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
    		    	        				fill: '#26C3FF',
    		    	        				stroke: '26C3FF'
    		    	        			},
    		    	        			'.inner':{
    		    	        				fill: '#26C3FF'
    		    	        			}
    		    	        		});
    		    	        	}
    		    	        	else if(mapPaperElement[cellView.model.id].type=='relation')
    		    	        	{
    		    	        		mapPaperElement[cellView.model.id].object.attr({
    		    	        			'.outer': {
				    	                    fill: '#26C3FF',
				    	                    stroke: 'none',
				    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
				    	                }
    		    	        		});
    		    	        		
    		    	        		
    		    	        	}
    		    	        	
    		    	        	selectedItems.push(cellView.model.id);
    		    	        	//aggiungo all array e colore l'elemento
    		    	        }
    		    	    });
    	        
    	        
    	        
    	        /*
    	        paper.on('cell:pointerdown', 
	    	    function(cellView, evt, x, y)
	    	    { 
	    	        alert('cell view ' + cellView.model.id + ' was clicked'); 
	    	    });
				*/
				
				// Per la colazione degli elementi -> (implementa la funzione sel_elementi) -> paper.on('cell:pointerclick', sel_elementi);
				
    	        paper.on('cell:unhighlight', function() {

    	            highlighter.remove();
    	        });
    	        
    	        var createLink = function(elm1, elm2) {
    	        	//alert("elm1 id:"+elm1.id+" elm2 id:"+elm2.id);

    	            var myLink = new erd.Line({
    	                markup: [
    	                    '<path class="connection" stroke="black" d="M 0 0 0 0"/>',
    	                    '<path class="connection-wrap" d="M 0 0 0 0"/>',
    	                    '<g class="labels"/>',
    	                    '<g class="marker-vertices"/>',
    	                    '<g class="marker-arrowheads"/>'
    	                ].join(''),
    	                source: { id: elm1.id },
    	                target: { id: elm2.id }
    	            });

    	            return myLink.addTo(graph);
    	        };

    	        var createLabel = function(txt) {
    	            return {
    	                labels: [{
    	                    position: -20,
    	                    attrs: {
    	                        text: { dy: -8, text: txt, fill: '#ffffff' },
    	                        rect: { fill: 'none' }
    	                    }
    	                }]
    	            };
    	        };
    	        
    	       
    	        for (var key in map_entity)
				{
    	        	if(map_entity[key].type=='simple')
    	        	{
						map_entity[key].object = new erd.Entity({

		    	            position: { x: map_entity[key].x, y: map_entity[key].y },
		    	            attrs: {
		    	                text: {
		    	                    fill: '#ffffff',
		    	                    text: map_entity[key].name,
		    	                    letterSpacing: 0,
		    	                    style: { textShadow: '1px 0 1px #333333' }
		    	                },
		    	                '.outer': {
		    	                    fill: '#31d0c6',
		    	                    stroke: 'none',
		    	                    filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
		    	                },
		    	                '.inner': {
		    	                    fill: '#31d0c6',
		    	                    stroke: 'none',
		    	                    filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
		    	                }
		    	            }
		    	        });
						
						//alert("position x: "+map_entity[key].object.prop('position/x'));
					
    	        	}
    	        	else if(map_entity[key].type=='spatial')
    	        	{
    	        		map_entity[key].object = new erd.Entity({

		    	            position: { x: map_entity[key].x, y: map_entity[key].y },
		    	            attrs: {
		    	                text: {
		    	                    fill: '#ffffff',
		    	                    text: map_entity[key].name,
		    	                    letterSpacing: 0,
		    	                    style: { textShadow: '1px 0 1px #333333' }
		    	                },
		    	                '.outer': {
		    	                    fill: '#a030d0',
		    	                    stroke: 'none',
		    	                    filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
		    	                },
		    	                '.inner': {
		    	                    fill: '#a030d0',
		    	                    stroke: 'none',
		    	                    filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
		    	                }
		    	            }
		    	        });
    	        	}
    	        	else if(map_entity[key].type=='weakEntity')
    	        	{
    	        		map_entity[key].object = new erd.WeakEntity({

    	    	            position: { x: map_entity[key].x, y: map_entity[key].y },
    	    	            attrs: {
    	     	                text: {
    	     	                    fill: '#ffffff',
    	     	                    text: map_entity[key].name,
    	     	                    letterSpacing: 0,
    	     	                    style: { textShadow: '1px 0 1px #333333' }
    	     	                },
    	     	                '.inner': {
    	     	                    fill: '#FF33A5',
    	     	                    stroke: 'none',
    	     	                    points: '155,5 155,55 5,55 5,5',
    	     	                   filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	     	                },
    	     	                '.outer': {
    	     	                    fill: 'none',
    	     	                    stroke: '#FF33A5',
    	     	                    points: '160,0 160,60 0,60 0,0',
    	     	                    filter: { name: 'blur',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	     	                }
    	     	            }
    	    	        });
    	        	}
    	        	
    	        	graph.addCells(map_entity[key].object);
    	        	
    	        	mapPaperElement[map_entity[key].object.id]=map_entity[key];
        			
        			//alert("Entity name:"+map_entity[key].name+"x: "+mapPaperElement[map_entity[key].object.id].object.prop('position/x')+" position y: "+mapPaperElement[map_entity[key].object.id].object.prop('position/y'));
        			
        			
    	        	
    	        	for(var i=0;i<map_entity[key].attribute.length;i++)
    	        		{
    	        			
    	        			if(map_entity[key].attribute[i].type=="normal")
    	        			{
    	        				map_entity[key].attribute[i].object = new erd.Normal({

        	        	            position: { x: map_entity[key].attribute[i].x, y: map_entity[key].attribute[i].y },
        	        	            attrs: {
        	        	                text: {
        	        	                    fill: '#ffffff',
        	        	                    text: map_entity[key].attribute[i].name,
        	        	                    letterSpacing: 0,
        	        	                    style: { textShadow: '1px 0 1px #333333' }
        	        	                },
        	        	                '.outer': {
        	        	                    fill: '#fe8550',
        	        	                    stroke: '#fe854f',
        	        	                    filter: { name: 'blur',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
        	        	                }
        	        	            }
        	        	        });
    	        				
    	        			}
    	        			
    	        			if(map_entity[key].attribute[i].key && map_entity[key].attribute[i].type=="normal")
    	        			{
    	        				map_entity[key].attribute[i].object = new erd.Key({

    	            	            position: { x: map_entity[key].attribute[i].x, y: map_entity[key].attribute[i].y },
    	            	            attrs: {
    	            	                text: {
    	            	                    fill: '#ffffff',
    	            	                    text: map_entity[key].attribute[i].name,
    	            	                    letterSpacing: 0,
    	            	                    style: { textShadow: '1px 0 1px #333333' }
    	            	                },
    	            	                '.outer': {
    	            	                    fill: '#feb662',
    	            	                    stroke: 'none',
    	            	                    filter: { name: 'blur',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	            	                },
    	            	                '.inner': {
    	            	                    fill: '#feb662',
    	            	                    stroke: 'none'
    	            	                }
    	            	            }
    	            	        });
    	        			}
    	        			else if (map_entity[key].attribute[i].type=="multiValued")
    	        			{
    	        				map_entity[key].attribute[i].object = new erd.Multivalued({

    	        	    	            position: { x: map_entity[key].attribute[i].x, y: map_entity[key].attribute[i].y },
    	        	    	            attrs: {
    	        	    	                text: {
    	        	    	                    fill: '#ffffff',
    	        	    	                    text: map_entity[key].attribute[i].name,
    	        	    	                    letterSpacing: 0,
    	        	    	                    style: { 'text-shadow': '1px 0px 1px #333333' }
    	        	    	                },
    	        	    	                '.inner': {
    	        	    	                    fill: '#fe8550',
    	        	    	                    stroke: 'none',
    	        	    	                    rx: 43,
    	        	    	                    ry: 21

    	        	    	                },
    	        	    	                '.outer': {
    	        	    	                    fill: '#464a65',
    	        	    	                    stroke: '#fe8550',
    	        	    	                    filter: { name: 'blur',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	        	    	                }
    	        	    	            }
    	        	    	        });
    	        			}
    	        			else if(map_entity[key].attribute[i].type=="derived")
    	        			{
    	        				map_entity[key].attribute[i].object = new erd.Derived({

    	            	            position: { x: map_entity[key].attribute[i].x, y: map_entity[key].attribute[i].y },
    	            	            attrs: {
    	            	                text: {
    	            	                    fill: '#ffffff',
    	            	                    text: map_entity[key].attribute[i].name,
    	            	                    letterSpacing: 0,
    	            	                    style: { textShadow: '1px 0 1px #333333' }
    	            	                },
    	            	                '.inner': {
    	            	                    fill: '#fca079',
    	            	                    stroke: 'none',
    	            	                    display: 'block'
    	            	                },
    	            	                '.outer': {
    	            	                    fill: '#464a65',
    	            	                    stroke: '#fe854f',
    	            	                    'stroke-dasharray': '3,1',
    	            	                    filter: { name: 'blur',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	            	                }
    	            	            }
    	            	        });
    	        			}
    	        			
    	        			graph.addCells(map_entity[key].attribute[i].object);
    	        			createLink(map_entity[key].object, map_entity[key].attribute[i].object);
    	        			
    	        			mapPaperElement[map_entity[key].attribute[i].object.id]=map_entity[key].attribute[i];
    	        			
    	        			//alert("Attribute name:"+map_entity[key].attribute[i].name+"x: "+mapPaperElement[map_entity[key].attribute[i].object.id].object.prop('position/x')+" position y: "+mapPaperElement[map_entity[key].attribute[i].object.id].object.prop('position/y'));
    	        			
    	        			
    	        		}
				}
    	        
    	        for (var key in map_relation)
				{
    	        	if(map_relation[key].type=='relation')
    	        	{
						map_relation[key].object = new erd.Relationship({

		    	            position: { x: map_relation[key].x, y: map_relation[key].y },
		    	            attrs: {
		    	                text: {
		    	                    fill: '#ffffff',
		    	                    text: map_relation[key].name,
		    	                    letterSpacing: 0,
		    	                    style: { textShadow: '1px 0 1px #333333' }
		    	                },
		    	                '.outer': {
		    	                    fill: '#797d9a',
		    	                    stroke: 'none',
		    	                    filter: { name: 'blur',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
		    	                }
		    	            }
		    	        });
						graph.addCells(map_relation[key].object);
						createLink(map_entity[map_relation[key].entityNameFirst].object,map_relation[key].object).set(createLabel('0..1'));
		    	        createLink(map_relation[key].object, map_entity[map_relation[key].entityNameSecond].object).set(createLabel('1..1'));
		    	        
		    	        mapPaperElement[map_relation[key].object.id]=map_relation[key];
	        			
	        			//alert("Relation name:"+map_relation[key].name+"x: "+mapPaperElement[map_relation[key].object.id].object.prop('position/x')+" position y: "+mapPaperElement[map_relation[key].object.id].object.prop('position/y'));
	        			
    	        	}
				}
					

    	        // Create shapes

    	        /*
    	        var employee = new erd.Entity({

    	            position: { x: 100, y: 200 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Employee',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.outer': {
    	                    fill: '#31d0c6',
    	                    stroke: 'none',
    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	                },
    	                '.inner': {
    	                    fill: '#31d0c6',
    	                    stroke: 'none',
    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	                }
    	            }
    	        });
    	        
    	        //alert("employee:"+employee.id);
    	        
    	        
    	        var wage = new erd.WeakEntity({

    	            position: { x: 530, y: 200 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Wage',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.inner': {
    	                    fill: '#31d0c6',
    	                    stroke: 'none',
    	                    points: '155,5 155,55 5,55 5,5'
    	                },
    	                '.outer': {
    	                    fill: 'none',
    	                    stroke: '#31d0c6',
    	                    points: '160,0 160,60 0,60 0,0',
    	                    filter: { name: 'dropShadow',  args: { dx: 0.5, dy: 2, blur: 2, color: '#333333' }}
    	                }
    	            }
    	        });
    	        

    	        var paid = new erd.IdentifyingRelationship({

    	            position: { x: 350, y: 190 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Gets paid',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.inner': {
    	                    fill: '#7c68fd',
    	                    stroke: 'none'
    	                },
    	                '.outer': {
    	                    fill: 'none',
    	                    stroke: '#7c68fd',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
    	                }
    	            }
    	        });
    	        
    	        
    	        var isa = new erd.ISA({

    	            position: { x: 125, y: 300 },
    	            attrs: {
    	                text: {
    	                    text: 'ISA',
    	                    fill: '#ffffff',
    	                    letterSpacing: 0,
    	                    style: { 'text-shadow': '1px 0 1px #333333' }
    	                },
    	                polygon: {
    	                    fill: '#fdb664',
    	                    stroke: 'none',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
    	                }
    	            }
    	        });
    	        

    	        var number = new erd.Key({

    	            position: { x: 10, y: 90 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Number',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.outer': {
    	                    fill: '#feb662',
    	                    stroke: 'none',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	                },
    	                '.inner': {
    	                    fill: '#feb662',
    	                    stroke: 'none'
    	                }
    	            }
    	        });

    	        var employeeName = new erd.Normal({

    	            position: { x: 75, y: 30 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Name',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.outer': {
    	                    fill: '#fe8550',
    	                    stroke: '#fe854f',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	                }
    	            }
    	        });

    	        var skills = new erd.Multivalued({

    	            position: { x: 150, y: 90 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Skills',
    	                    letterSpacing: 0,
    	                    style: { 'text-shadow': '1px 0px 1px #333333' }
    	                },
    	                '.inner': {
    	                    fill: '#fe8550',
    	                    stroke: 'none',
    	                    rx: 43,
    	                    ry: 21

    	                },
    	                '.outer': {
    	                    fill: '#464a65',
    	                    stroke: '#fe8550',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	                }
    	            }
    	        });

    	        var amount = new erd.Derived({

    	            position: { x: 440, y: 80 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Amount',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.inner': {
    	                    fill: '#fca079',
    	                    stroke: 'none',
    	                    display: 'block'
    	                },
    	                '.outer': {
    	                    fill: '#464a65',
    	                    stroke: '#fe854f',
    	                    'stroke-dasharray': '3,1',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 2, color: '#222138' }}
    	                }
    	            }
    	        });

    	        var uses = new erd.Relationship({

    	            position: { x: 300, y: 390 },
    	            attrs: {
    	                text: {
    	                    fill: '#ffffff',
    	                    text: 'Uses',
    	                    letterSpacing: 0,
    	                    style: { textShadow: '1px 0 1px #333333' }
    	                },
    	                '.outer': {
    	                    fill: '#797d9a',
    	                    stroke: 'none',
    	                    filter: { name: 'dropShadow',  args: { dx: 0, dy: 2, blur: 1, color: '#333333' }}
    	                }
    	            }
    	        });

    	        // Create new shapes by cloning

    	        var salesman = employee.clone().translate(0, 200).attr('text/text', 'Salesman');

    	        var date = employeeName.clone().position(585, 80).attr('text/text', 'Date');

    	        var car = employee.clone().position(430, 400).attr('text/text', 'Company car');

    	        var plate = number.clone().position(405, 500).attr('text/text', 'Plate');


    	        // Helpers

    	        var createLink = function(elm1, elm2) {
    	        	//alert("elm1 id:"+elm1.id+" elm2 id:"+elm2.id);

    	            var myLink = new erd.Line({
    	                markup: [
    	                    '<path class="connection" stroke="black" d="M 0 0 0 0"/>',
    	                    '<path class="connection-wrap" d="M 0 0 0 0"/>',
    	                    '<g class="labels"/>',
    	                    '<g class="marker-vertices"/>',
    	                    '<g class="marker-arrowheads"/>'
    	                ].join(''),
    	                source: { id: elm1.id },
    	                target: { id: elm2.id }
    	            });

    	            return myLink.addTo(graph);
    	        };

    	        var createLabel = function(txt) {
    	            return {
    	                labels: [{
    	                    position: -20,
    	                    attrs: {
    	                        text: { dy: -8, text: txt, fill: '#ffffff' },
    	                        rect: { fill: 'none' }
    	                    }
    	                }]
    	            };
    	        };

    	        // Add shapes to the graph

    	        graph.addCells([employee, salesman, wage, paid, isa, number, employeeName, skills, amount, date, plate, car, uses]);

    	        createLink(employee, paid).set(createLabel('1'));
    	        createLink(employee, number);
    	        createLink(employee, employeeName);
    	        createLink(employee, skills);
    	        createLink(employee, isa);
    	        createLink(isa, salesman);
    	        createLink(salesman, uses).set(createLabel('0..1'));
    	        createLink(car, uses).set(createLabel('1..1'));
    	        createLink(car, plate);
    	        createLink(wage, paid).set(createLabel('N'));
    	        createLink(wage, amount);
    	        createLink(wage, date);
    	        */
    	        
    	        $( "#operation" ).show();
    	       
    	}
    	
    	function save()
    	{
    		var elements=graph.getElements(); // funzione che preleva dallo schema tutti gli elementi
			 
    		var result="<uml:Model xmi:version=\"2.1\" xmlns:xmi=\"http://schema.omg.org/spec/XMI/2.1\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:ecore=\"http://www.eclipse.org/emf/2002/Ecore\" xmlns:uml=\"http://schema.omg.org/spec/UML/2.1.1\" xsi:schemaLocation=\"http://schema.omg.org/spec/UML/2.1.1 http://www.eclipse.org/uml2/2.0.0/UML\" xmi:id=\"_XrSbENk5EdyEZoPpUv3LUw\" name=\"Blank Model\">\n"+
    		"<packageImport xmi:type=\"uml:PackageImport\" xmi:id=\"_XrSbEdk5EdyEZoPpUv3LUw\">\n"+
    		"<importedPackage xmi:type=\"uml:Model\" href=\"http://schema.omg.org/spec/UML/2.1.1/uml.xml#_0\"/>\n"+
    		"</packageImport>\n\n";
    		
    		var flag=false;
    		
			for(var i=0;i<elements.length;i++)
			{
				if(mapPaperElement[elements[i].id].type=='relation')
				{
					if(flag)
					{
						result=result+"</packagedElement>\n\n";
						
						result=result+"<packagedElement xmi:type=\"uml:Association\" xmi:id=\""+mapPaperElement[elements[i].id].entityNameFirst+"__"+mapPaperElement[elements[i].id].entityNameSecond+"\" name=\""+mapPaperElement[elements[i].id].name+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\"  y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\" />\n";
						flag=false;
					}
					else
					{
						result=result+"<packagedElement xmi:type=\"uml:Association\" xmi:id=\""+mapPaperElement[elements[i].id].entityNameFirst+"__"+mapPaperElement[elements[i].id].entityNameSecond+"\" name=\""+mapPaperElement[elements[i].id].name+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\"  y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\" />\n";
					}
				}
				else if((mapPaperElement[elements[i].id].type=='derived')||(mapPaperElement[elements[i].id].type=='multiValued'))
				{
					result=result+"<ownedAttribute xmi:type=\"uml:Property\" name=\""+mapPaperElement[elements[i].id].name+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\" y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\" type=\""+mapPaperElement[elements[i].id].type+"\">\n"+
					"</ownedAttribute>\n";
					flag=true;
				}
				else if ((mapPaperElement[elements[i].id].type=='normal'))
				{
					if(mapPaperElement[elements[i].id].key)
					{
						result=result+"<ownedAttribute xmi:type=\"uml:Property\" name=\""+mapPaperElement[elements[i].id].name+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\" y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\" type=\"normal\">\n"+
							"<details key=\"PK\"/>\n"+
					    	"</ownedAttribute>\n";
					}
					else
					{
						result=result+"<ownedAttribute xmi:type=\"uml:Property\" name=\""+mapPaperElement[elements[i].id].name+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\" y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\" type=\"normal\">\n"+
						"</ownedAttribute>\n";
					}
					flag=true;
				}	    		
				else if((mapPaperElement[elements[i].id].type=='simple')||(mapPaperElement[elements[i].id].type=='weakEntity')|| (mapPaperElement[elements[i].id].type=='spatial'))
				{
					if(flag)
					{
						result=result+"</packagedElement>\n\n";
						
						result=result+"<packagedElement xmi:type=\"uml:Class\" name=\""+mapPaperElement[elements[i].id].name+"\" type=\""+mapPaperElement[elements[i].id].type+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\" y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\">\n";
						flag=false;
					}
					else
					{
						result=result+"<packagedElement xmi:type=\"uml:Class\" name=\""+mapPaperElement[elements[i].id].name+"\" type=\""+mapPaperElement[elements[i].id].type+"\" x=\""+mapPaperElement[elements[i].id].object.prop('position/x')+"\" y=\""+mapPaperElement[elements[i].id].object.prop('position/y')+"\">\n";
					}
				}
        			
			}
			
			result=result+"</uml:Model>";
			
			modelXMI=new Object();
			modelXMI.action="write";
			modelXMI.text=result;
			//alert(JSON.stringify(modelXMI));
			$.ajax({
			           url: "WriteFile",
			           type: 'GET',
			             data: { 
			                 elements: JSON.stringify(modelXMI)
			               },
			             dataType: "JSON",
			             contentType: 'application/json',
			             mimeType: 'application/json',
			             
			             success: function (jsonStr) {
			                   //alert(JSON.stringify(jsonStr));
			                 
			                
			             }
			       });
			
			$("#alert").append( "<div class='alert alert-success alert-dismissible fade show' role='alert'>"+
					  "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>"+
		    "<span aria-hidden='true'>&times;</span>"+
		    "</button><strong>Well done!</strong> The new file citibike.xmi has been generated.</div>" );
			
    	}
    	
    </script>
</body>
</html>


